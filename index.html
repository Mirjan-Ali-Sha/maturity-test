<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maturity Index</title>
    
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>

    <div id="splash-screen">
        <div class="splash-logo">üìà</div>
        <div class="splash-title">MATURITY INDEX</div>
        <div class="splash-tagline">Reflect. React. Evolve.</div>
        <div class="author-credit">Created by Mirjan Ali Sha</div>
    </div>

    <div class="app-container">
        
        <button id="pause-btn" class="btn btn-float" style="display: none;" onclick="pauseGame()">‚è∏</button>

        <div id="screen-home" class="screen active">
            <div style="text-align:center;">
                <img src="icon.svg" style="width: 80px; height: 80px; margin-bottom: 10px; filter: drop-shadow(0 5px 15px rgba(99,102,241,0.4)); animation: float 4s ease-in-out infinite;">
            </div>
            <h1>Maturity Index</h1>
            <p style="margin-bottom: 2rem;">Master your life skills across 5 dimensions.</p>
            
            <div id="resume-container" style="display:none; margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="resumeGame()">Resume Saved Game ‚ñ∂</button>
            </div>

            <h3>Select Difficulty</h3>
            <div class="level-grid" id="level-list">
                </div>
        </div>

        <div id="screen-game" class="screen">
            <div class="header-bar">
                <span id="game-level-display" style="font-weight:bold; color:var(--text-light)">Level</span>
                <span class="category-tag" id="q-category">Category</span>
            </div>
            <div class="progress-container">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            <h2 id="q-text">Question...</h2>
            <div id="options-container"></div>
        </div>

        <div id="modal-pause" class="modal">
            <h2>Game Paused</h2>
            <button class="btn" onclick="resumeGame()">Continue</button>
            <button class="btn btn-secondary" onclick="quitGame()">Quit to Menu</button>
        </div>

        <div id="screen-dashboard" class="screen">
            
            <div class="badge-container" id="badge-display">
                <div class="badge-header">
                    <div class="badge-app-icon">
                        <img src="icon.svg" alt="App Icon">
                    </div>
                    <div style="text-align:left; line-height:1.2">
                        <small style="font-weight:800; display:block; color:#1f2937; font-size: 1rem; text-transform:uppercase;">Maturity Index</small>
                        <small style="font-size:0.7rem; color:#6b7280;">Reflect. React. Evolve.</small>
                    </div>
                </div>

                <span class="badge-icon">üèÜ</span>
                <h3 id="badge-title" style="margin:5px 0; color:#374151;">Level Completed</h3>
                <p id="badge-player" style="font-weight:bold; font-size:1.4rem; color:var(--primary); margin: 5px 0;">Player Name</p>
                
                <div style="font-size: 3.5rem; font-weight: 900; color: var(--primary-dark); line-height:1; margin: 10px 0;" id="final-score">0</div>
                <small style="color:#6b7280; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">Overall Score</small>

                <div id="badge-stats-mini" style="margin-top:20px; display:flex; justify-content:center; gap:6px;">
                    </div>

                <div class="badge-footer">
                    Created by <br>
                    <strong>Mirjan Ali Sha</strong>
                </div>
            </div>

            <button class="btn btn-save" onclick="downloadBadge()">üì∏ Save Badge to Gallery</button>
            
            <div id="stats-breakdown" style="margin-top:20px;"></div>
            <button class="btn btn-secondary" onclick="quitGame()">Back to Home</button>
        </div>
    </div>

    <div id="offscreen-capture" style="position:absolute; left:-9999px; top:0; width: 350px;"></div>

    <script src="questions.js"></script>
    <script>
        // --- CONFIGURATION ---
        const LEVELS = [
            { id: 'easy',    name: 'Easy',    count: 2,  icon: 'üå±' }, 
            { id: 'medium',  name: 'Medium',  count: 4,  icon: 'üåø' }, 
            { id: 'hard',    name: 'Hard',    count: 6,  icon: 'üå≥' }, 
            { id: 'advance', name: 'Advance', count: 8,  icon: 'üå≤' }, 
            { id: 'expert',  name: 'Expert',  count: 10, icon: 'üëë' }  
        ];

        // Weights
        const CATEGORY_WEIGHTS = {
            "Emotional":    1.5,
            "Financial":    1.2,
            "Professional": 1.0, 
            "Social":       1.0,
            "Resilience":   0.8  
        };

        let gameState = { active: false, levelId: null, queue: [], currentIndex: 0, scores: {}, playerName: "" };

        // INIT
        window.onload = () => {
            const splash = document.getElementById('splash-screen');
            setTimeout(() => {
                splash.classList.add('hidden');
                setTimeout(() => { splash.style.display = 'none'; }, 800);
            }, 2500);

            renderLevelSelect();
            checkSavedGame();
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
        };

        function renderLevelSelect() {
            const container = document.getElementById('level-list');
            container.innerHTML = '';
            const highScores = JSON.parse(localStorage.getItem('maturity_high_scores') || '{}');

            LEVELS.forEach(lvl => {
                const score = highScores[lvl.id] ? Math.round(highScores[lvl.id]) : null;
                const totalQuestions = lvl.count * 5; 

                const div = document.createElement('div');
                div.className = 'level-card';
                
                let scoreHtml = '';
                if (score !== null) {
                    scoreHtml = `
                        <div class="score-pill-container">
                            <span class="score-pill">Best: ${score}</span>
                            <button class="btn-icon-small" onclick="downloadHighScore('${lvl.id}', '${lvl.name}', ${score}, event)">
                                üì•
                            </button>
                        </div>
                    `;
                } else {
                    scoreHtml = `<span style="font-size:0.8rem; color:#9ca3af; font-weight:500;">Start</span>`;
                }

                div.innerHTML = `
                    <div style="display:flex; align-items:center; gap: 15px;" onclick="startNewGame('${lvl.id}')">
                        <span style="font-size:2rem;">${lvl.icon}</span>
                        <div style="text-align:left;">
                            <div style="font-weight:700; font-size:1.1rem; color:var(--text);">${lvl.name}</div>
                            <div style="font-size:0.85rem; color:#6b7280; font-weight:500;">${totalQuestions} Questions</div>
                        </div>
                    </div>
                    ${scoreHtml}
                `;
                container.appendChild(div);
            });
        }

        function checkSavedGame() {
            const saved = localStorage.getItem('maturity_save_state');
            document.getElementById('resume-container').style.display = saved ? 'block' : 'none';
        }

        // --- GAME LOGIC ---
        function startNewGame(levelId) {
            // NOTE: We do NOT ask for name here anymore. We ask at end.
            const levelConfig = LEVELS.find(l => l.id === levelId);
            gameState = {
                active: true, levelId: levelId, playerName: "Player", // Default placeholder
                queue: generateQuestionQueue(levelConfig.count),
                currentIndex: 0, scores: {}
            };
            Object.keys(questionData).forEach(cat => { gameState.scores[cat] = { earned: 0, possible: 0 }; });

            saveGameState();
            switchScreen('screen-game');
            document.getElementById('pause-btn').style.display = 'flex';
            document.getElementById('game-level-display').innerText = levelConfig.name;
            renderQuestion();
        }

        function generateQuestionQueue(countPerCat) {
            let queue = [];
            let seenIDs = JSON.parse(localStorage.getItem('maturity_seen_questions') || '[]');
            
            for (const [category, questions] of Object.entries(questionData)) {
                let available = questions.filter(q => !seenIDs.includes(q.id));
                if (available.length < countPerCat) {
                    // Recycle IDs
                    const catIds = questions.map(q => q.id);
                    seenIDs = seenIDs.filter(id => !catIds.includes(id));
                    available = [...questions];
                }
                // Shuffle available
                for (let i = available.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [available[i], available[j]] = [available[j], available[i]];
                }
                
                const selected = available.slice(0, countPerCat);
                selected.forEach(q => {
                    queue.push({ ...q, category });
                    seenIDs.push(q.id);
                });
            }
            localStorage.setItem('maturity_seen_questions', JSON.stringify(seenIDs));
            return queue.sort(() => 0.5 - Math.random());
        }

        function renderQuestion() {
            if (gameState.currentIndex >= gameState.queue.length) { endGame(); return; }
            const q = gameState.queue[gameState.currentIndex];
            document.getElementById('q-category').innerText = q.category;
            document.getElementById('q-text').innerText = q.text;
            const pct = (gameState.currentIndex / gameState.queue.length) * 100;
            document.getElementById('progress-fill').style.width = `${pct}%`;
            
            const optContainer = document.getElementById('options-container');
            optContainer.innerHTML = '';
            const shuffledOptions = [...q.options].sort(() => 0.5 - Math.random());
            shuffledOptions.forEach(opt => {
                const btn = document.createElement('div');
                btn.className = 'option-card';
                btn.innerText = opt.text;
                btn.onclick = () => handleAnswer(q, opt.weight);
                optContainer.appendChild(btn);
            });
        }

        function handleAnswer(q, w) {
            gameState.scores[q.category].earned += (w * q.weight);
            gameState.scores[q.category].possible += (1.0 * q.weight);
            gameState.currentIndex++;
            saveGameState();
            renderQuestion();
        }

        function pauseGame() { document.getElementById('modal-pause').classList.add('visible'); }
        
        function resumeGame() {
            if (!gameState.active) {
                const saved = localStorage.getItem('maturity_save_state');
                if (saved) {
                    gameState = JSON.parse(saved);
                    gameState.active = true;
                    switchScreen('screen-game');
                    document.getElementById('pause-btn').style.display = 'flex';
                    renderQuestion();
                }
            }
            document.getElementById('modal-pause').classList.remove('visible');
        }
        function saveGameState() { localStorage.setItem('maturity_save_state', JSON.stringify(gameState)); }
        
        function quitGame() {
            gameState.active = false;
            document.getElementById('pause-btn').style.display = 'none';
            document.getElementById('modal-pause').classList.remove('visible');
            switchScreen('screen-home');
            renderLevelSelect();
            checkSavedGame();
        }

        // --- SCORING & BADGE GEN ---
        function endGame() {
            localStorage.removeItem('maturity_save_state');
            document.getElementById('pause-btn').style.display = 'none';

            let totalWeightedScore = 0;
            let totalWeightUsed = 0;
            const statsContainer = document.getElementById('stats-breakdown');
            const miniStatsContainer = document.getElementById('badge-stats-mini');
            statsContainer.innerHTML = '';
            miniStatsContainer.innerHTML = '';

            for (const [cat, data] of Object.entries(gameState.scores)) {
                const rawPercent = data.possible === 0 ? 0 : (data.earned / data.possible) * 100;
                const weight = CATEGORY_WEIGHTS[cat] || 1.0;
                totalWeightedScore += (rawPercent * weight);
                totalWeightUsed += weight;

                // Full Stat Bar
                statsContainer.innerHTML += `
                    <div class="stat-row">
                        <span style="width:100px;">${cat}</span>
                        <div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${rawPercent}%"></div></div>
                        <span style="width:40px; text-align:right;">${Math.round(rawPercent)}%</span>
                    </div>`;
                
                // Mini dots for Badge
                const color = rawPercent > 70 ? '#10b981' : (rawPercent > 40 ? '#f59e0b' : '#ef4444');
                miniStatsContainer.innerHTML += `<div style="width:10px; height:10px; border-radius:50%; background:${color};" title="${cat}"></div>`;
            }

            const finalScore = totalWeightUsed === 0 ? 0 : Math.round(totalWeightedScore / totalWeightUsed);
            
            // Save High Score
            const highScores = JSON.parse(localStorage.getItem('maturity_high_scores') || '{}');
            if (finalScore > (highScores[gameState.levelId] || 0)) {
                highScores[gameState.levelId] = finalScore;
                localStorage.setItem('maturity_high_scores', JSON.stringify(highScores));
            }

            // Populate Badge Details (Temporary name until download)
            const levelName = LEVELS.find(l => l.id === gameState.levelId).name;
            document.getElementById('badge-title').innerText = `${levelName} Level`;
            
            // Use stored name if available, else placeholder
            const storedName = localStorage.getItem('maturity_player_name');
            document.getElementById('badge-player').innerText = storedName || "Your Name Here";
            
            document.getElementById('final-score').innerText = finalScore;

            switchScreen('screen-dashboard');
        }

        // --- DOWNLOAD LOGIC WITH NAME PROMPT ---

        function downloadBadge() {
            // 1. Ask for Name
            let currentName = document.getElementById('badge-player').innerText;
            if(currentName === "Your Name Here" || currentName === "Player") {
                currentName = ""; 
            }
            
            const newName = prompt("Please enter your name for the badge:", currentName);
            
            // If user cancels prompt, we still proceed but with placeholder/old name? 
            // Better to only proceed if they enter something or leave it as is.
            if(newName !== null && newName.trim() !== "") {
                document.getElementById('badge-player').innerText = newName;
                localStorage.setItem('maturity_player_name', newName); // Remember for next time
            }

            // 2. Generate Image
            const badgeElement = document.getElementById('badge-display');
            html2canvas(badgeElement, {
                scale: 3, // High Res
                backgroundColor: null, // Transparent background (CSS handles white box)
                useCORS: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Maturity_Badge_${gameState.levelId}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            });
        }

        // Triggered from Home Screen "Download Icon"
        function downloadHighScore(levelId, levelName, score, event) {
            event.stopPropagation();

            // 1. Ask for name
            let playerName = localStorage.getItem('maturity_player_name') || "";
            const newName = prompt("Enter your name for this badge:", playerName);
            
            if(newName !== null && newName.trim() !== "") {
                playerName = newName;
                localStorage.setItem('maturity_player_name', newName);
            } else if (playerName === "") {
                playerName = "Player"; // Fallback
            }

            // 2. Setup Offscreen Badge
            const container = document.getElementById('offscreen-capture');
            container.innerHTML = document.getElementById('badge-display').outerHTML;
            const tempBadge = container.querySelector('.badge-container');
            
            tempBadge.querySelector('#badge-title').innerText = `${levelName} Level`;
            tempBadge.querySelector('#badge-player').innerText = playerName;
            tempBadge.querySelector('#final-score').innerText = score;
            tempBadge.querySelector('#badge-stats-mini').innerHTML = ''; 

            // 3. Capture
            html2canvas(tempBadge, {
                scale: 3,
                backgroundColor: null
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Maturity_Best_${levelId}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
                container.innerHTML = ''; 
            });
        }

        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    </script>
</body>
</html>
